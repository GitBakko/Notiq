<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <security>
      <requestFiltering>
        <fileExtensions>
          <remove fileExtension=".config" />
          <add fileExtension=".config" allowed="true" />
        </fileExtensions>
      </requestFiltering>
    </security>
    <rewrite>
      <rules>
        <!-- Reverse Proxy for WebSocket -->
        <rule name="WebSocket Proxy" stopProcessing="true">
          <match url="^ws(.*)" />
          <action type="Rewrite" url="http://localhost:3001/ws{R:1}" />
        </rule>

        <!-- Reverse Proxy for API -->
        <rule name="API Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <action type="Rewrite" url="http://localhost:3001/api/{R:1}" />
        </rule>

        <!-- Reverse Proxy for Uploads -->
        <rule name="Uploads Proxy" stopProcessing="true">
          <match url="^uploads/(.*)" />
          <action type="Rewrite" url="http://localhost:3001/uploads/{R:1}" />
        </rule>

        <!-- Safety Net: Never rewrite API/Uploads/WS to index.html -->
        <!-- If Proxy rules above fail or don't match, STOP here. Return 404 (or static) rather than React App. -->
        <rule name="Block React Fallback for Backend Paths" stopProcessing="true">
          <match url="^(api|uploads|ws)/.*" />
          <action type="None" />
        </rule>

        <!-- React Routes (SPA Fallback) -->
        <rule name="React Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <!-- Exclude API and Uploads explicitly to prevent recursion -->
            <add input="{REQUEST_URI}" pattern="^/api/.*" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/uploads/.*" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/ws/.*" negate="true" />
          </conditions>
          <action type="Rewrite" url="/" />
        </rule>
      </rules>
      <outboundRules>
        <rule name="NoCachePWAFiles" preCondition="IsPWAFile">
          <match serverVariable="RESPONSE_Cache-Control" pattern=".*" />
          <action type="Rewrite" value="no-cache, no-store, must-revalidate" />
        </rule>
        <preConditions>
          <preCondition name="IsPWAFile">
            <add input="{REQUEST_URI}" pattern="^/(sw\.js|index\.html|registerSW\.js|manifest\.webmanifest|push-sw\.js)$" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>
    <staticContent>
      <mimeMap fileExtension=".webp" mimeType="image/webp" />
      <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
    </staticContent>
  </system.webServer>
</configuration>
